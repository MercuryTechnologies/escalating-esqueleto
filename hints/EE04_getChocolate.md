First, read the error carefully.

Which pieces of this query need to be moved from plain Haskell to an Esqueleto context?
